<div class="song-view-container">

    <!-- Files -->
    <div class="section-header">
        <h2>Dateien</h2>    
        <button mat-mini-fab (click)="fileInput.click()" aria-label="Add file">
            <mat-icon>add</mat-icon>
        </button>
    </div>
    <input #fileInput type="file" accept="audio/*" style="display:none" (change)="onAudioFileSelected($event)">
    <ul>
        @if(song?.audiofiles?.length || 0 > 0) {
            @for (file of song?.audiofiles; track $index) {
                <li>
                {{file.name}}
                </li>
            }
        } @else {
            <p>Noch keine Lieddateien</p>
        }
    </ul>   

    <!-- Text -->
    <div class="section-header">
        <h2>Text</h2>
        <button mat-mini-fab  [matMenuTriggerFor]="menu" aria-label="Toggle Text Mode">
            <mat-icon>
                {{
                    (textmode === 'edit') ? 'edit_note' : 
                    (textmode === 'mark') ? 'border_color' :
                    (textmode === 'view') ? 'visibility' : 'visibility' 
                }}
            </mat-icon>
        </button>
        <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="textmode = 'edit'">
                <mat-icon>edit_note</mat-icon>
                <span>Text bearbeiten</span>
            </button>
            <button mat-menu-item (click)="textmode = 'mark'">
                <mat-icon>border_color</mat-icon>
                <span>Text markieren</span>
            </button>
            <button mat-menu-item (click)="textmode = 'view'">
                <mat-icon>visibility</mat-icon>
                <span>Text ansehen</span>
            </button>
        </mat-menu>
    </div>

    @if (song) {    
        <!-- Song Marking or Viewing -->
        @if (textmode === 'mark' || textmode === 'view') {
            <div class="song-text-scroll-outer">
                <div class="blur-top" [class.visible]="!atTop"></div>
                <div class="song-text-scroll-container"
                     #scrollContainer
                     (scroll)="onTextScroll(scrollContainer)">
                  <mat-list>
                    @for (line of (song.text.split('\n')); track $index) {
                        <mat-list-item class="song-line">
                            <div class="song-line-inner">
                              <div class="song-line-text" (click)="onLineClick($index)">
                                {{ line }}
                              </div>
                              <div class="song-line-cue">
                                @if (song.cues[$index]) {
                                    {{ song.cues[$index] | mmss}}  
                                }
                              </div>
                            </div>
                          </mat-list-item>
                    }
                  </mat-list>
                </div>
                <div class="blur-bottom" [class.visible]="!atBottom"></div>
            </div>
        <!-- Song Editing -->
        } @else if (textmode === 'edit') {
            <mat-form-field class="song-text-area">
                <textarea matInput
                        class="song-text-area"
                        placeholder="Songtext"
                        [(ngModel)]="song.text"
                        rows="15"
                        (blur)="saveText()"></textarea>
            </mat-form-field>
        } 
    }

    @if(song?.audiofiles?.length || 0 > 0) {
        <audio #audioRef [src]="'data:' + song!.audiofiles[0].mimeType + ';base64,' + song!.audiofiles[0].bytes"
            (timeupdate)="onTimeUpdate(audioRef)"
            (loadedmetadata)="onLoadedMetadata(audioRef)">
        </audio>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="min-width: 40px;">{{ audioRef.currentTime| mmss }}</span>
            <mat-slider 
                style="flex: 1;"
                [min]="0"
                [max]="duration"
                (input)="onSeek($event, audioRef)">
                <input matSliderThumb            
                [value]="audioRef.currentTime">
            </mat-slider>
            <span style="min-width: 40px;">{{ (duration - audioRef.currentTime) | mmss }}</span>
        </div>
        <div class="song-control-buttons">
            <button mat-fab color="primary" (click)="togglePlay(audioRef)">
                <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
            </button>
        </div>
    }
</div>