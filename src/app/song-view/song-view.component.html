<div class="song-view-container">

    @if ((song?.audiofiles?.length || 0) == 0) {
      <div 
      class="file-upload-dropzone"
      (drop)="onFileDrop($event)"
      (dragover)="onFileDragOver($event)"
      (dragleave)="onFileDragLeave($event)"
      [class.dragover]="isDragOver"
      (click)="fileInput.click()"
      tabindex="0"
      (keydown.enter)="fileInput.click()"
      (keydown.space)="fileInput.click()"
    >
      <input 
        #fileInput 
        type="file" 
        accept="audio/mpeg,audio/mp3,audio/m4a,.m4a,.mp3,video/mp4,video/*,.mp4"
        style="display:none"
        (change)="onFileSelected($event)"
      >
      <div class="file-upload-text">
        <mat-icon>cloud_upload</mat-icon>
        <span>
          Song-Datei hierher ziehen oder klicken, um auszuw√§hlen
        </span>
      </div>
    </div>
    }
    <!-- Text -->
    <div class="section-header">
      <ng-container *ngIf="!showTextModeMenu; else menuTemplate">
        <div class="textmode-buttons">
          <button mat-mini-fab [class.active]="textmode === 'edit'" (click)="textmode = 'edit'" aria-label="Text bearbeiten">
            <mat-icon>edit_note</mat-icon>
          </button>
          <button mat-mini-fab [class.active]="textmode === 'mark'" (click)="textmode = 'mark'" aria-label="Text markieren">
            <mat-icon>border_color</mat-icon>
          </button>
          <button mat-mini-fab  [class.active]="textmode === 'view'" (click)="textmode = 'view'" aria-label="Text ansehen">
            <mat-icon>visibility</mat-icon>
          </button>
        </div>
      </ng-container>
      <ng-template #menuTemplate>
        <div class="textmode-buttons">
          <button mat-mini-fab [matMenuTriggerFor]="menu" aria-label="Toggle Text Mode">
            <mat-icon>
              {{
                (textmode === 'edit') ? 'edit_note' : 
                (textmode === 'mark') ? 'border_color' :
                (textmode === 'view') ? 'visibility' : 'visibility' 
              }}
            </mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="textmode = 'edit'">
              <mat-icon>edit_note</mat-icon>
              <span>Text bearbeiten</span>
            </button>
            <button mat-menu-item (click)="textmode = 'mark'">
              <mat-icon>border_color</mat-icon>
              <span>Text markieren</span>
            </button>
            <button mat-menu-item (click)="textmode = 'view'">
              <mat-icon>visibility</mat-icon>
              <span>Text ansehen</span>
            </button>
          </mat-menu>
        </div>
      </ng-template>
    </div>

    @if (song) {    
        <!-- Song Marking or Viewing -->
        @if (textmode === 'mark' || textmode === 'view') {
            <div class="song-text-scroll-outer">
                <div class="blur-top" [class.visible]="!atTop"></div>
                <div class="song-text-scroll-container"
                     #scrollContainer
                     (scroll)="onTextScroll(scrollContainer)">
                  <mat-list>
                    <div class="song-bars monospace-text">
                      @for (line of songBars; track $index) {
                        <app-song-bar
                          #lineItem
                          [line]="line"
                          [isCurrent]="isCurrentLine($index)"
                          [cue]="song.cues[$index]"
                          [voices]="voices"
                          (click)="onLineClick($index)">
                        </app-song-bar>
                      }
                    </div>
                  </mat-list>
                </div>
                <div class="blur-bottom" [class.visible]="!atBottom"></div>
            </div>
        <!-- Song Editing -->
        } @else if (textmode === 'edit') {
            <mat-form-field>
              <textarea matInput
                class="song-text-area monospace-text"
                placeholder="Songtext"
                [(ngModel)]="song.text"
                (blur)="saveText()"></textarea>
            </mat-form-field>
        } 
    }

    <!-- Song Controll -->
    @if(song && song.audiofiles[0] && audioFileBytes) {
        <div class="song-control-fixed">
          @if(song.audiofiles[0].mimeType.startsWith('video/')) {
            <video #audioRef
              [src]="'data:' + song!.audiofiles[0].mimeType + ';base64,' + audioFileBytes"
              (timeupdate)="onTimeUpdate(audioRef)"
              (loadedmetadata)="onLoadedMetadata(audioRef)"
              [attr.controls]="false"
              style="width: 100%; max-height: 480px; background: #000;">
            </video>
            <div class="song-control-slider">
              <span style="min-width: 40px;">{{ currentTime| mmss }}</span>
              <mat-slider 
                style="flex: 1;"
                [min]="0"
                [max]="duration"
                (input)="onSeek($event, audioRef)">
                <input matSliderThumb [value]="currentTime">
              </mat-slider>
              <span style="min-width: 40px;">{{ (duration - currentTime) | mmss }}</span>
            </div>
            <div class="song-control-buttons">
              <button mat-fab color="primary" (click)="togglePlay(audioRef)">
                <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
              </button>
            </div>
          } @else {
            <audio #audioRef
              [src]="'data:' + song!.audiofiles[0].mimeType + ';base64,' + audioFileBytes"
              (timeupdate)="onTimeUpdate(audioRef)"
              (loadedmetadata)="onLoadedMetadata(audioRef)">
            </audio>
            <div class="song-control-slider">
              <span style="min-width: 40px;">{{ currentTime| mmss }}</span>
              <mat-slider 
                style="flex: 1;"
                [min]="0"
                [max]="duration"
                (input)="onSeek($event, audioRef)">
                <input matSliderThumb [value]="currentTime">
              </mat-slider>
              <span style="min-width: 40px;">{{ (duration - currentTime) | mmss }}</span>
            </div>
            <div class="song-control-buttons">
              <button mat-fab color="primary" (click)="togglePlay(audioRef)">
                <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
              </button>
            </div>
          }
        </div>
      }
</div>